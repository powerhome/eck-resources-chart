{{- $values := .Values }}
{{- if .Values.machineDeployments }}
{{- range $md := .Values.machineDeployments }}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: {{ $values.cluster.name }}-{{ $md.name}}
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          criSocket: /var/run/containerd/containerd.sock
          kubeletExtraArgs:
            cloud-provider: external
          name: '{{`{{ local_hostname }}`}}'
{{- with $values.kubeadmConfigSpec.files }}
      files:
      {{- toYaml . | nindent 6 }}
{{- end }}
      preKubeadmCommands:
      {{- toYaml $values.kubeadmConfigSpec.preKubeadmCommands | nindent 6 }}
      users:
      - name: capv
        sshAuthorizedKeys:
        {{- toYaml $values.kubeadmConfigSpec.sshAuthorizedKeys | nindent 8 }}
        sudo: ALL=(ALL) NOPASSWD:ALL
{{- end }}
{{- end }}
